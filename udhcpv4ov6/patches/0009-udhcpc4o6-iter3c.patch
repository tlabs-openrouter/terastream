From c68ad9efd8ff64bf5fe86bb2cafe0e11c2a2143f Mon Sep 17 00:00:00 2001
From: Leonardo Jelenkovic <leonardo.jelenkovic@gmail.com>
Date: Tue, 4 Mar 2014 10:42:29 +0100
Subject: [PATCH 09/17] udhcpc4o6: iter3c

---
 networking/udhcp/dhcp4o6.c |  3 ++-
 networking/udhcp/dhcpc.c   | 26 +++++++++++++-------------
 2 files changed, 15 insertions(+), 14 deletions(-)

diff --git a/networking/udhcp/dhcp4o6.c b/networking/udhcp/dhcp4o6.c
index c41e535..4f7fa6f 100644
--- a/networking/udhcp/dhcp4o6.c
+++ b/networking/udhcp/dhcp4o6.c
@@ -288,7 +288,8 @@ int dhcp4o6_init (int port, char *cip6, char *sip6)
 	}
 
 	//FIXME choose between SOCKET_RAW and SOCKET_KERNEL with additional flag!
-	dhcp4o6_data.socket_mode = SOCKET_RAW;
+//	dhcp4o6_data.socket_mode = SOCKET_RAW;
+	dhcp4o6_data.socket_mode = SOCKET_KERNEL;
 
 	return 0;
 }
diff --git a/networking/udhcp/dhcpc.c b/networking/udhcp/dhcpc.c
index b9a1175..c336939 100644
--- a/networking/udhcp/dhcpc.c
+++ b/networking/udhcp/dhcpc.c
@@ -1415,6 +1415,19 @@ int udhcpc_main(int argc UNUSED_PARAM, char **argv)
 		logmode |= LOGMODE_SYSLOG;
 	}
 
+#if ENABLE_FEATURE_DHCP4o6C
+	if ( (opt & OPT_6) ) {
+		client_config.mode4o6 = 1;
+		if ( !(opt & OPT_I) )
+			str_6c = NULL;
+#if ENABLE_FEATURE_UDHCP_PORT
+		dhcp4o6_init ((opt & OPT_P), str_6c, str_6s);
+#else
+		dhcp4o6_init (0, str_6c, str_6s);
+#endif
+	}
+#endif
+
 	/* Make sure fd 0,1,2 are open */
 	bb_sanitize_stdio();
 	/* Equivalent of doing a fflush after every \n */
@@ -1435,19 +1448,6 @@ int udhcpc_main(int argc UNUSED_PARAM, char **argv)
 	timeout = 0;
 	already_waited_sec = 0;
 
-#if ENABLE_FEATURE_DHCP4o6C
-	if ( (opt & OPT_6) ) {
-		client_config.mode4o6 = 1;
-		if ( !(opt & OPT_I) )
-			str_6c = NULL;
-#if ENABLE_FEATURE_UDHCP_PORT
-		dhcp4o6_init ((opt & OPT_P), str_6c, str_6s);
-#else
-		dhcp4o6_init (0, str_6c, str_6s);
-#endif
-	}
-#endif
-
 	/* Main event loop. select() waits on signal pipe and possibly
 	 * on sockfd.
 	 * "continue" statements in code below jump to the top of the loop.
-- 
2.0.1

