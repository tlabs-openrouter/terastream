From 405f14a98f2a0cf91a50137cfcf62c1c71e783f2 Mon Sep 17 00:00:00 2001
From: Leonardo Jelenkovic <leonardo.jelenkovic@gmail.com>
Date: Mon, 5 May 2014 14:06:31 +0200
Subject: [PATCH 14/17] TTL adjustment for DHCPv4-o-DHCPv6

---
 networking/udhcp/d6_packet.c | 12 +++++++++++-
 networking/udhcp/dhcp4o6.h   |  3 +++
 2 files changed, 14 insertions(+), 1 deletion(-)

diff --git a/networking/udhcp/d6_packet.c b/networking/udhcp/d6_packet.c
index 4a0fe16..539d5ee 100644
--- a/networking/udhcp/d6_packet.c
+++ b/networking/udhcp/d6_packet.c
@@ -11,6 +11,10 @@
 #include <netinet/if_ether.h>
 #include <netpacket/packet.h>
 
+#if ENABLE_FEATURE_DHCP4o6C
+#include "dhcp4o6.h"
+#endif
+
 #if defined CONFIG_UDHCP_DEBUG && CONFIG_UDHCP_DEBUG >= 2
 void FAST_FUNC d6_dump_packet(struct d6_packet *packet)
 {
@@ -105,7 +109,13 @@ int FAST_FUNC d6_send_raw_packet(
 				offsetof(struct ip6_udp_d6_packet, data) - 4 + d6_pkt_size
 	);
 	/* fix 'hop limit' and 'next header' after UDP checksumming */
-	packet.ip6.ip6_hlim = 10; /* observed Windows machines to use hlim=1 */
+
+#if ENABLE_FEATURE_DHCP4o6C
+	/* 4o6 server could be a few hops away */
+	packet.ip6.ip6_hlim = DHCPv4oDHCPv6_TTL;
+#else
+	packet.ip6.ip6_hlim = 1; /* observed Windows machines to use hlim=1 */
+#endif
 	packet.ip6.ip6_nxt = IPPROTO_UDP;
 
 	d6_dump_packet(d6_pkt);
diff --git a/networking/udhcp/dhcp4o6.h b/networking/udhcp/dhcp4o6.h
index 6984b3f..e81b0a5 100644
--- a/networking/udhcp/dhcp4o6.h
+++ b/networking/udhcp/dhcp4o6.h
@@ -31,6 +31,9 @@ PUSH_AND_SET_FUNCTION_VISIBILITY_TO_HIDDEN
 #define SOCKET_KERNEL 1
 #define SOCKET_RAW    2
 
+/* TTL for DHCP4oDHCP6 packets when they are send over SOCKET_RAW */
+#define DHCPv4oDHCPv6_TTL    40
+
 
 struct dhcp4o6_data_t {
 	/* our IPv6 address & port */
-- 
2.0.1

