From 139953494b9de36138fea38d8731f65fb4b6bb0d Mon Sep 17 00:00:00 2001
From: l30nard0 <leonardo.jelenkovic@gmail.hr>
Date: Fri, 28 Feb 2014 10:00:21 +0100
Subject: [PATCH 03/17] udhcp 4o6: iter1

---
 networking/udhcp/d6_dhcpc.c | 64 ++++++++++++++++++++++++---------------------
 networking/udhcp/dhcpc.c    |  8 +++++-
 2 files changed, 41 insertions(+), 31 deletions(-)

diff --git a/networking/udhcp/d6_dhcpc.c b/networking/udhcp/d6_dhcpc.c
index 02eeb4f..338f806 100644
--- a/networking/udhcp/d6_dhcpc.c
+++ b/networking/udhcp/d6_dhcpc.c
@@ -1579,27 +1579,6 @@ int dhcp4o6_recv_raw_packet (struct in6_addr *peer_ipv6
 	return d6_recv_raw_packet(peer_ipv6,&d6_pkt,sockfd);
 }
 
-int dhcp4o6_send_raw_packet (struct dhcp_packet *dhcp_pkt,
-		uint32_t source_nip, int source_port,
-		uint32_t dest_nip, int dest_port, const uint8_t *dest_arp,
-		int ifindex)
-{
-	struct d6_packet packet;
-	struct d6_option *opt;
-	uint8_t *opt8;
-	uint size;
-
-	if ( client_config.xid6 == 0 )
-		client_config.xid6 = random_xid();
-
-	/* create DHCPv6 packet of type D6_MSG_DHCPV4_QUERY */
-	opt8 = opt = init_d6_packet ( &packet, D6_OPT_DHCPV4_MSG, client_config.xid6 );
-
-	//to be continued... (tommorrow; ops later today)
-
-
-
-}
 int dhcp4o6_send_kernel_packet (struct dhcp_packet *dhcp_pkt,
 		uint32_t source_nip, int source_port,
 		uint32_t dest_nip, int dest_port)
@@ -1611,17 +1590,42 @@ int dhcp4o6_send_kernel_packet (struct dhcp_packet *dhcp_pkt,
 			MAC_BCAST_ADDR, client_config.ifindex);
 }
 
-#endif
-
-static uint8_t *init_d6_packet(struct d6_packet *packet, char type, uint32_t xid)
+int dhcp4o6_send_raw_packet (struct dhcp_packet *packet4,
+		uint32_t source_nip, int source_port,
+		uint32_t dest_nip, int dest_port, const uint8_t *dest_arp,
+		int ifindex)
 {
-	struct d6_option *clientid;
+	struct d6_packet packet6; /* is packet large enough? */
+	struct d6_option *opt;
+	uint8_t *d6end;
+	uint d4size, d6size;
 
-	memset(packet, 0, sizeof(*packet));
+	d4size = offsetof(struct dhcp_packet, options) + 
+			udhcp_end_option (packet4->options);
+	
+	if ( client_config.xid6 == 0 )
+		client_config.xid6 = random_xid();
 
-	packet->d6_xid32 = xid;
-	packet->d6_msg_type = type;
+	/* create DHCPv6 packet of type D6_MSG_DHCPV4_QUERY */
+	opt = init_d6_packet ( &packet6, D6_OPT_DHCPV4_MSG, client_config.xid6 );
 
-	clientid = (void*)client_config.clientid;
-	return d6_store_blob(packet->d6_options, clientid, clientid->len + 2+2);
+	/* content of DHCPv6 packet is option D6_OPT_DHCPV4_MSG with DHCPv4 packet */
+	opt->code_hi = 0;
+	opt->code = D6_OPT_DHCPV4_MSG;
+	opt->len_hi = d4size >> 8;
+	opt->len = d4size & 0x00ff;
+	memcpy ( opt->data, packet4, d4size );
+
+	/* send packet */
+	d6size = 32 + 32 + d4size; /* d6 header + option header + d4 packet */
+	d6end = ((uint8_t *)&packet6) + d6size;
+
+	return d6_send_raw_packet(
+		packet6, d6size,
+		/*src*/ NULL, source_port, /* FIXME: can we get source ipv6? */
+		/*dst*/ &server_config.dst_ipv6, dest_port, dest_arp,
+		ifindex
+	);
 }
+
+#endif
diff --git a/networking/udhcp/dhcpc.c b/networking/udhcp/dhcpc.c
index 59a7569..a25d5ad 100644
--- a/networking/udhcp/dhcpc.c
+++ b/networking/udhcp/dhcpc.c
@@ -1331,8 +1331,14 @@ int udhcpc_main(int argc UNUSED_PARAM, char **argv)
 
 #if ENABLE_FEATURE_DHCP4o6C
 	client_config.mode4o6 = (opt & OPT_6);
-	if ( client_config.mode4o6 )
+	if ( client_config.mode4o6 ) {
+		static const uint8_t FF02__1_2[16] = {
+			0xFF, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+			0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x02,
+		};
+		memcpy ( &server_config.dst_ipv6, FF02__1_2, 16 );
 		client_config.xid6 = 0;
+	}
 #endif
 
 	if (opt & OPT_r)
-- 
2.0.1

